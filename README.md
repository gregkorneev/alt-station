# Проект ALT‑Station

Добро пожаловать в проект ALT‑Station! Это сборник скриптов, системных единиц и инструкций для превращения ноутбука или рабочей станции под управлением ALT Linux в полноценный «мини‑сервер» для собственных нужд.

## Состав проекта

- **Bot.md** — Telegram‑бот для мониторинга батареи, температуры и состояния вентилятора. Отправляет уведомления и поддерживает безопасные команды.
- **file.md** — способы организации доступа к файлам (Samba, Tailscale Serve).
- **vs_code.md** — удалённый Visual Studio Code через code‑server, VS Code Tunnel и Remote SSH.

## Структура репозитория

```
alt-station/
├── battery_bot.py
├── batterybot.service
├── docs/
│   ├── Bot.md
│   ├── file.md
│   └── vs_code.md
└── README.md
```

## Как пользоваться

1. Ознакомьтесь с `Bot.md`, чтобы запустить бота мониторинга.
2. Для доступа к файлам — настройте Samba или Tailscale Serve (`file.md`).
3. Для удалённой разработки — разверните `code-server` по инструкции в `vs_code.md`.

## Целевая аудитория

Для владельцев ноутбуков/станций под ALT Linux, желающих:
- получать уведомления о разряде батареи;
- иметь быстрый доступ к файлам;
- работать с кодом через браузер.

## Обратная связь

Нашли ошибку или хотите предложить улучшения — создайте issue или pull request.



# Бот мониторинга заряда и температуры ALT‑Station

Этот репозиторий содержит скрипт на Python и юнит systemd для запуска Telegram‑бота на рабочей станции ALT Linux (или любом современном дистрибутиве Linux). Бот следит за уровнем заряда батареи ноутбука, температурой процессора и состоянием вентилятора и отправляет уведомления в Telegram, когда батарея разряжается или когда меняется состояние питания. Также бот предоставляет команды для запроса текущего состояния по требованию и опциональную интерактивную оболочку для администратора.

> **Примечание**  
> Этот бот **не** скачивает и не выполняет произвольный код. Интерактивная оболочка по умолчанию отключена и может быть включена только при явном указании идентификатора администраторского чата и установке флага ``ENABLE_UNSAFE_SHELL``.

## Возможности

* **Мониторинг батареи** – периодически проверяет уровень заряда батареи с помощью ``upower`` и отправляет уведомления подписчикам, когда он падает ниже настраиваемого порога ( по умолчанию 20 %) и когда восстанавливается ( по умолчанию ≥ 25 %). Также сообщает, когда сетевой адаптер подключён или отключён.
* **Температура и состояние вентилятора** – если доступен ``lm_sensors``, считывает температуру ЦП и скорость вентилятора через ``sensors -j``. При возможности использует информацию о тепловых зонах и устройствах hwmon из ``/sys``. Запросы к датчикам можно полностью отключить, установив ``DISABLE_SENSORS=1``.
* **Команды через Telegram**:
  - ``/battery`` – показать текущий процент заряда, состояние зарядки, температуру и состояние вентилятора.
  - ``/subscribe`` и ``/unsubscribe`` – управляют отправкой уведомлений в текущий чат.
  - ``/run <алиас>`` – выполнить предопределенную безопасную команду на хосте ( см. ``battery_bot.py`` для списка). ``/run help`` показажет доступные алиасы.
  - ``/whoami`` – отобразить ваш chat_id ( нужен для настройки прав администратора).
  - ``/adminstatus``, ``/setadmin <id>``, ``/enable_shell`` и ``/disable_shell`` – менеджмент прав админа и флага небезопасной оболочки.
  - ``/linux`` – открыть интерактивную shell‑сессию (только для админа; по умолчанию отключено). Последующие сообщения выполняются как shell‑команды. Используйте ``/cd``, ``/pwd`` и ``/exit`` для навигации.
  - ``/exec <команда>`` – выполнить одну shell‑команду (только для админа; по умолчанию отключено).

## Предварительные требования

Перед установкой бота убедитесь, что:

1. **Python 3.7+** установлен. ALT Linux по умолчанию с Python.
2. Установлены пакеты **upower** и **lm_sensors**. Установите их командой:

   ```bash
   sudo apt-get update
   sudo apt-get install upower lm_sensors python3-pip
   # необязательно, но рекомендуется: обнаружить доступные датчики
   sudo sensors-detect
   ```

3. Установлены необходимые библиотеки Python для бота:

   ```bash
   python3 -m pip install --upgrade "python-telegram-bot[job-queue]==20.7"
   ```

4. У вас есть **токен Telegram‑бота**. Создайте бота через [@BotFather](https://t.me/BotFather):
   - Начните чат с @BotFather и отправьте ``/newbot``.
   - Выберите имя и username для вашего бота.
   - Скопируйте API‑токен, который выдаст BotFather – он нужен для переменной ``BOT_TOKEN``.

5. (Полезно для админкоманд) знаете **свой chat_id**. После запуска бота отправьте ему ``/whoami`` – в ответ он пришлёт ваш числовой ID. Укажите это в переменной ``ADMIN_CHAT_ID`` или задайте его через ``/setadmin``.

## Установка

Склонируйте этот репозиторий на целевой машине:

```bash
git clone <url-репозитория> ~/alt-station
cd ~/alt-station
```

Ключевые файлы:

* **``battery_bot.py``** – основной Python‑скрипт бота.
* **``batterybot.service``** – пример юнита systemd для запуска бота как пользовательской службы.
* **``README.md``** – текущая документация.

### Запуск вручную

Установите нужные переменные окружения и запустите скрипт:

```bash
export BOT_TOKEN="<токен вашего Telegram‑бота>"
python3 battery_bot.py
```

Бот начнёт опрашивать Telegram и отвечать на команды.

### Установка как пользовательская служба ( рекомендуется )

Запуск бота через systemd‑службу **пользователя** гарантирует, что он автоматически запускается при входе в систему. Для установки:

1. Скопируйте юнит systemd в каталог пользовательских сервисов и отредактируйте его, указав ваш токен и прочие параметры:

   ```bash
   mkdir -p ~/.config/systemd/user
   cp batterybot.service ~/.config/systemd/user/
   # Отредактируйте сервис, чтобы указать BOT_TOKEN и прочие переменные
   nano ~/.config/systemd/user/batterybot.service
   ```

   При необходимости измените путь в ``ExecStart=``.

2. Перезагрузите manager systemd пользователя и включите/запусте службу:

   ```bash
   systemctl --user daemon-reload
   systemctl --user enable --now batterybot.service
   ```

3. Проверьте, что бот запущен:

   ```bash
   systemctl --user status batterybot.service
   ```

Теперь бот будет работать в фоне при каждом входе в систему.

## Настройка через переменные окружения

В файле службы определяются переменные окружения, управляющие поведением бота. Их можно менять или добавлять в секции ``[Service]`` файла ``batterybot.service``:

| Переменная | Описание |
|----------------------------|---------|
| **BOT_TOKEN** | *Обязательна.* API‑токен Telegram от @BotFather. |
| **CHECK_INTERVAL_SEC** | Как часто проверять батарею (секунды). По умолчанию ``60``. |
| **ALERT_THRESHOLD** | Процент заряда для отравки сообщения о низком заряде. По умолчанию ``20``. |
| **ALERT_HYSTERESIS** | Процент заряда для отправки уведомления о восстановлении. По умолчанию ``25``. |
| **ADMIN_CHAT_ID** | ID чата, которому разрешены админкоманды. ``0`` – отключено. |
| **ENABLE_UNSAFE_SHELL** | Установите ``1``, чтобы разрешить интерактивную оболочку и команду ``/exec``. |
| **DISABLE_SENSORS** | Установите ``1``, чтобы не вызывать ``sensors`` (если lm_sensors не настроен). |
| **STATE_DIR** | Каталог для хранения файлов состояния. Поумолчанию ``~/.battery_bot``. |

После изменения файла службы запустите:

```bash
systemctl --user daemon-reload
systemctl --user restart batterybot.service
```

## Использование бота

1. **Запустите бот** и откройте чат с ним в Telegram.
2. Отправьте ``/start``, чтобы увидеть список команд. ``/battery`` покажет текущий заряд, температуру и состояние вентилятора.
3. Отправьте ``/subscribe``, чтобы получать уведомления о низком заряде и изменениях состояния питания; ``/unsubscribe`` отключает их.
4. Если у вас настроен ``ADMIN_CHAT_ID``, можно включить интерактивную оболочку:

   ```bash
   # через переменные окружения
   export ADMIN_CHAT_ID=<ваш id>
   export ENABLE_UNSAFE_SHELL=1
   # или через Telegram
   /setadmin <ваш id>
   /enable_shell
   ```

   Затем отправьте ``/linux``, чтобы открыть shell‑сессию. Любые следующие сообщения будут выполняться на хосте. ``/exit`` закрывает сеанс.

5. ``/run help`` покажет доступные безопасные команды.

## Решение проблем

* **Бот не отвечает** – убедитесь, что служба запущена и ``BOT_TOKEN`` указан верно. Проверьте журнал командой ``journalctl --user -u batterybot.service -f``.
* **Температура отображается как «n/a»** – возможно, нужно запустить ``sudo sensors-detect`` и загрузить нужные модули ядра, или установить ``DISABLE_SENSORS=1``.
* **Команды shell не работают** – убедитесь, что задали ``ADMIN_CHAT_ID`` и установили ``ENABLE_UNSAFE_SHELL=1``.

## Вклад

Приглашаем открывать Issue или Pull Request, чтобы улучшить бот: можно добавить новые безопасные алиасы в ``SAFE_CMD_MAP`` или расширить функционал.
